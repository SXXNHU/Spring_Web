 # ìŠ¤í”„ë§ ì…ë¬¸ ì •ë¦¬ #6

## âœ” ëª©í‘œ
ìˆœìˆ˜ JDBCë¡œ ì½”ë“œë¥¼ ì‘ì„±í•´ë³´ì.

<br/>

## âœ” ëª©ì°¨
* í™˜ê²½ì„¤ì •
* Jdbc ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„
* ìŠ¤í”„ë§ ì„¤ì • ë³€ê²½ **(ì¤‘ìš”)**

<br/>

## ğŸ’¡ 6-1 í™˜ê²½ì„¤ì •

### ğŸ“Œ build.gradle

```java
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
runtimeOnly 'com.h2database:h2'
```

build.gradle íŒŒì¼ì—  íŒŒì¼ì— jdbc, h2 ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€í•œë‹¤.

<br/>

### ğŸ“Œ resources/application.properties

```java
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
```

`resources/application.properties` ì— ìŠ¤í”„ë§ë¶€íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •ì„ ì¶”ê°€í•œë‹¤.

<br/>

## ğŸ’¡ 6-2 Jdbc ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„

### **ì£¼ì˜**

ì´ë ‡ê²Œ JDBC APIë¡œ ì§ì ‘ ì½”ë”©í•˜ëŠ” ë°©ì‹ì€ 20ë…„ ì „ ì´ì•¼ê¸°ì´ë‹¤. ì½”ë“œëŠ” ì¤‘ìš”í•˜ì§€ ì•Šìœ¼ë‹ˆ ì°¸ê³ ë§Œ í•˜ê³  ë„˜ì–´ê°€ë„ëœë‹¤.

```java
public class JdbcMemberRepository implements MemberRepository {

    private final DataSource dataSource;

    public JdbcMemberRepository(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    @Override
    public Member save(Member member) {
        String sql = "insert into member(name) values(?)";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql,
                    Statement.RETURN_GENERATED_KEYS);
            pstmt.setString(1, member.getName());
            pstmt.executeUpdate();
            rs = pstmt.getGeneratedKeys();
            if (rs.next()) {
                member.setId(rs.getLong(1));
            } else {
                throw new SQLException("id ì¡°íšŒ ì‹¤íŒ¨");
            }
            return member;
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }

    @Override
    public Optional<Member> findById(Long id) {
        String sql = "select * from member where id = ?";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setLong(1, id);
            rs = pstmt.executeQuery();
            if(rs.next()) {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                return Optional.of(member);
            } else {
                return Optional.empty();
            }
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }


    @Override
    public List<Member> findAll() {
        String sql = "select * from member";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            rs = pstmt.executeQuery();
            List<Member> members = new ArrayList<>();
            while(rs.next()) {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                members.add(member);
            }
            return members;
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }


    @Override
    public Optional<Member> findByName(String name) {
        String sql = "select * from member where name = ?";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setString(1, name);
            rs = pstmt.executeQuery();
            if(rs.next()) {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                return Optional.of(member);
            }
            return Optional.empty();
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }
    private Connection getConnection() {
        return DataSourceUtils.getConnection(dataSource);
    }
    private void close(Connection conn, PreparedStatement pstmt, ResultSet rs)
    {
        try {
            if (rs != null) {
                rs.close();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        try {
            if (pstmt != null) {
                pstmt.close();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        try {
            if (conn != null) {
                close(conn);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private void close(Connection conn) throws SQLException {
        DataSourceUtils.releaseConnection(conn, dataSource);
    }
}
```

<br/>

## ğŸ’¡ 6-3 ìŠ¤í”„ë§ ì„¤ì • ë³€ê²½

```java
@Configuration
public class SpringConfig {

    private final DataSource dataSource;

    @Autowired
    public SpringConfig(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    @Bean
    public MemberService memberService(){
        return new MemberService(memberRepository());
    }

    @Bean
    public MemberRepository memberRepository(){
        //return new MemoryMemberRepository();
        return new JdbcMemberRepository(dataSource);
    }
}
```

ìœ„ì˜ ì½”ë“œë¥¼ ë³´ë©´ `memberRepository` ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ê°€ ê³ ì‘ ì£¼ì„ì²˜ë¦¬ëœ í•œì¤„ì˜ ì½”ë“œë¥¼ ë³€ê²½í–ˆë”ë‹ˆ ë‹¤ë¥¸ êµ¬í˜„ì²´ë¡œ ë°”ë€Œì—ˆë‹¤. **ë‹¤ë¥¸ ì½”ë“œëŠ” ë‹¨ í•˜ë‚˜ë„ ê³ ì¹  í•„ìš”ê°€ ì—†ë‹¤.**

ì´ëŸ° íš¨ìœ¨ì ì¸ ì‘ì—…ì´ ê°€ëŠ¥í•œ ì´ìœ ëŠ” **ìŠ¤í”„ë§ì´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë¥¼ ì§€ì›í•´ì¤˜ì„œ ê°ì²´ ì§€í–¥ ì›ë¦¬ì¸ ë‹¤í˜•ì„±(ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ì²´ ë°”ê¿”ì¹˜ê¸°)ì„ ì‰½ê²Œ í™œìš©í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤. ì´ë¥¼ DI(Dependency Injection)ì´ë¼ê³  ë¶€ë¥¸ë‹¤.**

ë§Œì•½ ì´ ë°©ë²•ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤ë©´ ìš°ë¦¬ëŠ” `memberService`ì—ì„œ `MemoryMemberRepository`ë¥¼ í™œìš©í•œ ëª¨ë“  ë¶€ë¶„ì„ ë°”ê¿”ì•¼í•  ê²ƒì´ë‹¤.

```java
public class MemberService {

    private final MemberRepository memberRepository = new MemoryMemberRepository();
    //ë³€ê²½ í•„ìš”
    ...
}
```

ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ê°€ ë°”ë€ŒëŠ” ëª¨ìŠµì„ ê·¸ë¦¼ìœ¼ë¡œ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

![5](https://user-images.githubusercontent.com/55661631/104714426-871d6d00-5768-11eb-87c7-ae5b9507cc36.PNG)

<br/>

# ì°¸ê³ 
* [ì¸í”„ëŸ° ìŠ¤í”„ë§ ì…ë¬¸ - ì½”ë“œë¡œ ë°°ìš°ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸, ì›¹ MVC, DB ì ‘ê·¼ ê¸°ìˆ ](https://www.inflearn.com)
