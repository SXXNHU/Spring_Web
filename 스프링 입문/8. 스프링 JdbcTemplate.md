# ìŠ¤í”„ë§ ì…ë¬¸ ì •ë¦¬ #8

# âœ” ëª©í‘œ
ìŠ¤í”„ë§ JdbcTemplateì— ëŒ€í•´ ê³µë¶€í•´ë³´ì.

<br/>

# âœ” ëª©ì°¨
* í™˜ê²½ì„¤ì •
* ìŠ¤í”„ë§ JdbcTemplate íšŒì› ë¦¬í¬ì§€í† ë¦¬
* JdbcTemplateì„ ì‚¬ìš©í•˜ë„ë¡ ìŠ¤í”„ë§ ì„¤ì • ë³€ê²½

<br/>

# ğŸ’¡ 8-1 í™˜ê²½ì„¤ì •

ìˆœìˆ˜ Jdbcì™€ ë™ì¼í•œ í™˜ê²½ì„¤ì •ì„ í•˜ë©´ ëœë‹¤.

## **build.gradle**

```java
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
runtimeOnly 'com.h2database:h2'
```

build.gradle íŒŒì¼ì—  íŒŒì¼ì— jdbc, h2 ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€í•œë‹¤.

<br/>

## **resources/application.properties**

```java
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
```

`resources/application.properties` ì— ìŠ¤í”„ë§ë¶€íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •ì„ ì¶”ê°€í•œë‹¤.

<br/>

# ğŸ’¡ 8-2 ìŠ¤í”„ë§ JdbcTemplate íšŒì› ë¦¬í¬ì§€í† ë¦¬

ìŠ¤í”„ë§ JdbcTemplateê³¼ Mybatis ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” JDBC APIì—ì„œ ë³¸ ë°•ë³µ ì½”ë“œë¥¼ ëŒ€ë¶€ë¶„ ì œê±°í•´ì¤€ë‹¤. í•˜ì§€ë§Œ SQLì€ ì§ì ‘ ì‘ì„±í•´ì•¼í•œë‹¤.

ìˆœìˆ˜ JDBCì—ì„œ ì‘ì„±í•œ ë¦¬í¬ì§€í† ë¦¬ ë©”ì†Œë“œë“¤ì„ JdbcTemplate ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ ë°”ê¿”ë³´ê² ë‹¤.

<br/>

## **ìƒì„±ì ì£¼ì…**

```java
private final JdbcTemplate jdbcTemplate;

public JdbcTemplateMemberRepository(DataSource dataSource) {
    jdbcTemplate = new JdbcTemplate(dataSource);
}
```

JdbcTemplateë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” dataSourceë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì•„ ìƒì„±í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— ìƒì„±ìë¡œ ì˜ì¡´ì„± ì£¼ì…ì„ ì‹œì¼œì¤€ë‹¤.

dataSourceëŠ” DBì™€ ê´€ê³„ëœ connection ì •ë³´ë¥¼ ë‹´ê³  ìˆìœ¼ë©° ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ì˜¬ë¼ê°ˆ ë•Œ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡ëœë‹¤. ê·¸ë˜ì„œ ìœ„ì™€ ê°™ì´ ì˜ì¡´ì„± ì£¼ì…ì´ ê°€ëŠ¥í•˜ë‹¤.

ìœ„ ì½”ë“œë¥¼ ë³´ë©´ @Autowired ì• ë…¸í…Œì´ì…˜ì´ ë¹ ì§„ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ìƒì„±ìê°€ í•˜ë‚˜ë©´ í•´ë‹¹ ì• ë…¸í…Œì´ì…˜ì€ ìƒëµí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤. ìƒì„±ìê°€ 2ê°œ ì´ìƒì´ë©´ ìƒëµì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. 

<br/>

## **memberRowMapper()**

```java
private RowMapper<Member> memberRowMapper(){
    //ëŒë‹¤ì‹ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥ ()->{};
    return new RowMapper<Member>() {
        @Override
        public Member mapRow(ResultSet rs, int rowNum) throws SQLException {
            Member member = new Member();
            member.setId(rs.getLong("id"));
            member.setName(rs.getString("name"));
            return member;
        }
    };
}
```

ì¿¼ë¦¬ë¬¸ì˜ ê²°ê³¼ë¥¼ ì €ì¥í•  RowMapper ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ë¥¼ ë°˜í™˜í•˜ëŠ” ë©”ì†Œë“œì´ë‹¤.

mapRow ë©”ì†Œë“œì˜ ResultSet rsëŠ” ì¿¼ë¦¬ë¬¸ì˜ ê²°ê³¼ê°’ì„ ì „ë‹¬ë°›ëŠ” ë§¤ê°œë³€ìˆ˜ì´ë©°, rsë¥¼ ì´ìš©í•´ ë§´ë²„ ê°ì²´ë¥¼ ìƒì„±í•´ ë¦¬í„´í•´ì¤€ë‹¤. 

## **save()**

```java
public Member save(Member member) {
    // ì•„ë˜ 4ì¤„ë¡œ insert ë¬¸ ìƒì„±
    SimpleJdbcInsert jdbcInsert = new SimpleJdbcInsert(jdbcTemplate);
    // insert ë¬¸ì˜ í…Œì´ë¸” ëª…, pk ì„¤ì •
    jdbcInsert.withTableName("member").usingGeneratedKeyColumns("id");
    // insertí•  ì»¬ëŸ¼ë“¤ ì„¤ì •
    Map<String, Object> parameters = new HashMap<>();
    parameters.put("name", member.getName());
    // insertë¬¸ ì‹¤í–‰ í›„ pk(id)ë¥¼ ë°˜í™˜ë°›ìŒ
    Number key = jdbcInsert.executeAndReturnKey(new MapSqlParameterSource(parameters));
    member.setId(key.longValue());
    return member;
}
```

InsertëŠ” ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì‘ì„±í•˜ì§€ ì•Šê³  ìœ„ ì½”ë“œì™€ ê°™ì´ SimpleJdbcInsertë¥¼ ì‚¬ìš©í•´ ì¿¼ë¦¬ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆë‹¤. 

<br/>

## **findById(), findByName(), findAll()**

```java
public Optional<Member> findById(Long id) {
    List<Member> result = jdbcTemplate.query("select * from member where id = ?", memberRowMapper(), id);
    return result.stream().findAny();
}

public Optional<Member> findByName(String name) {
    List<Member> result = jdbcTemplate.query("select * from member where name = ?", memberRowMapper(), name);
    return result.stream().findAny();
}

public List<Member> findAll() {
    return jdbcTemplate.query("select * from member", memberRowMapper());
}
```

select ì¿¼ë¦¬ë“¤ì€ jdbcTemplateì˜ query ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•œë‹¤. ì „ë‹¬í•  ì¸ìˆ˜ë¡œëŠ” ì¿¼ë¦¬ë¬¸, ê²°ê³¼ê°’ì„ ë°›ì„ ê°ì²´, ì „ë‹¬í•  ë³€ìˆ˜ê°€ ìˆë‹¤.

<br/>

## **ì „ì²´ ì½”ë“œ**

```java
public class JdbcTemplateMemberRepository implements MemberRepository{

    private final JdbcTemplate jdbcTemplate;

    public JdbcTemplateMemberRepository(DataSource dataSource) {
        jdbcTemplate = new JdbcTemplate(dataSource);
    }

    @Override
    public Member save(Member member) {
        SimpleJdbcInsert jdbcInsert = new SimpleJdbcInsert(jdbcTemplate);
        jdbcInsert.withTableName("member").usingGeneratedKeyColumns("id");
        Map<String, Object> parameters = new HashMap<>();
        parameters.put("name", member.getName());

        Number key = jdbcInsert.executeAndReturnKey(new MapSqlParameterSource(parameters));
        member.setId(key.longValue());
        return member;
    }

    @Override
    public Optional<Member> findById(Long id) {
        List<Member> result = jdbcTemplate.query("select * from member where id = ?", memberRowMapper(), id);
        return result.stream().findAny();
    }

    @Override
    public Optional<Member> findByName(String name) {
        List<Member> result = jdbcTemplate.query("select * from member where name = ?", memberRowMapper(), name);
        return result.stream().findAny();
    }

    @Override
    public List<Member> findAll() {
        return jdbcTemplate.query("select * from member", memberRowMapper());
    }

    private RowMapper<Member> memberRowMapper(){
        return new RowMapper<Member>() {
            @Override
            public Member mapRow(ResultSet rs, int rowNum) throws SQLException {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                return member;
            }
        };
    }
}
```

<br/>

# ğŸ’¡ 8-3 JdbcTemplateì„ ì‚¬ìš©í•˜ë„ë¡ ìŠ¤í”„ë§ ì„¤ì • ë³€ê²½

## **SpringConfig**

```java
@Configuration
public class SpringConfig {

    private final DataSource dataSource;

    @Autowired
    public SpringConfig(DataSource dataSource) {
        this.dataSource = dataSource;
    }
    

    private final MemberRepository memberRepository;

    @Autowired
    public SpringConfig(MemberRepository memberRepository) {
        this.memberRepository = memberRepository;
    }


    @Bean
    public MemberService memberService(){
        return new MemberService(memberRepository);
    }

    @Bean
    public MemberRepository memberRepository(){
        return new JdbcTemplateMemberRepository(dataSource);
    }
}
```

<br/>

# ì°¸ê³ 
* [ì¸í”„ëŸ° ìŠ¤í”„ë§ ì…ë¬¸ - ì½”ë“œë¡œ ë°°ìš°ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸, ì›¹ MVC, DB ì ‘ê·¼ ê¸°ìˆ ](https://www.inflearn.com)